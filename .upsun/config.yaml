applications:
  app:
    source:
      root: "/"

    # Version de Node.js
    type: "nodejs:20"

    build:
      flavor: none

    # Hooks de build
    hooks:
      build: |
        set -e
        echo "Installing dependencies..."
        npm ci --prefer-offline --no-audit
        echo "Building Next.js application..."
        npm run build

      deploy: |
        echo "Application deployed successfully"

    # Configuration du serveur web
    web:
      commands:
        start: "npm start -- -p $PORT"

      locations:
        "/":
          passthru: true
          allow: false

        # Cache pour les assets statiques Next.js
        "/_next/static":
          allow: true
          expires: 1y
          rules:
            \.(css|js|gif|jpe?g|png|svg|ico|woff2?)$:
              allow: true

        # Fichiers publics
        "/public":
          allow: true
          root: "public"
          expires: 1h
          rules:
            \.(css|js|gif|jpe?g|png|svg|ico|pdf|woff2?)$:
              allow: true

    # Montage pour le cache Next.js (persistant entre les d√©ploiements)
    mounts:
      "/.next/cache":
        source: storage
        source_path: next_cache

    # Variables d'environnement
    variables:
      env:
        NODE_ENV: "production"

# Configuration des routes
routes:
  # Redirection HTTP domaine apex vers HTTPS www
  "http://sinese.fr/":
    type: redirect
    to: "https://www.sinese.fr/"

  # Redirection HTTPS domaine apex vers HTTPS www
  "https://sinese.fr/":
    type: redirect
    to: "https://www.sinese.fr/"

  # Redirection HTTP www vers HTTPS www
  "http://www.sinese.fr/":
    type: redirect
    to: "https://www.sinese.fr/"

  # Route principale HTTPS www (application)
  "https://www.sinese.fr/":
    type: upstream
    upstream: "app:http"
    cache:
      enabled: true
      cookies: ["*"]
