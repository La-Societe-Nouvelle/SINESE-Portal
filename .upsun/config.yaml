applications:
  app:
    source:
      root: "/"

    # Version de Node.js
    type: "nodejs:20"

    build:
      flavor: none

    # Hooks de build
    hooks:
      build: |
        set -e
        echo "Installing dependencies..."
        npm ci --prefer-offline --no-audit
        echo "Building Next.js application..."
        npm run build

      deploy: |
        echo "Application deployed successfully"

    # Configuration du serveur web
    web:
      commands:
        start: "npm start -- -p $PORT"

      locations:
        "/":
          passthru: true
          allow: false

        # Cache pour les assets statiques Next.js
        "/_next/static":
          allow: true
          expires: 1y
          rules:
            \.(css|js|gif|jpe?g|png|svg|ico|woff2?)$:
              allow: true

        # Fichiers publics
        "/public":
          allow: true
          root: "public"
          expires: 1h
          rules:
            \.(css|js|gif|jpe?g|png|svg|ico|pdf|woff2?)$:
              allow: true

    # Montage pour le cache Next.js (persistant entre les déploiements)
    mounts:
      "/.next/cache":
        source: storage
        source_path: next_cache

    # Variables d'environnement
    variables:
      env:
        NODE_ENV: "production"
        # Augmente la heap size Node.js à 1.5GB pour éviter les crashes mémoire
        NODE_OPTIONS: "--max-old-space-size=1536"
        # Désactive la télémétrie Next.js
        NEXT_TELEMETRY_DISABLED: "1"

# Configuration des routes
routes:
  # Route par défaut pour les environnements de staging (domaines auto-générés)
  "https://{default}/":
    type: upstream
    upstream: "app:http"
    cache:
      enabled: false

  "http://{default}/":
    type: redirect
    to: "https://{default}/"

  # Redirection HTTP domaine apex vers HTTPS www
  "http://sinese.fr/":
    type: redirect
    to: "https://www.sinese.fr/"

  # Redirection HTTPS domaine apex vers HTTPS www
  "https://sinese.fr/":
    type: redirect
    to: "https://www.sinese.fr/"

  # Redirection HTTP www vers HTTPS www
  "http://www.sinese.fr/":
    type: redirect
    to: "https://www.sinese.fr/"

  # Route principale HTTPS www (application)
  "https://www.sinese.fr/":
    type: upstream
    upstream: "app:http"
    cache:
      enabled: false

  # Route HTTPS publications (sous-domaine)
  "https://publication.sinese.fr/":
    type: upstream
    upstream: "app:http"
    cache:
      enabled: false
    redirects:
      paths:
        "/":
          to: "https://www.sinese.fr/publications"
          prefix: true
          append_suffix: true
          code: 301

  # Redirection de publication.sinese.fr vers www.sinese.fr/publications/ (avec le chemin)
  "https://publication.sinese.fr/{path}":
    type: redirect
    to: "https://www.sinese.fr/publications/{path}"
